<!DOCTYPE html>
<html lang="en">

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
        integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/1.0.2/package/lib/browser/fs.js"></script>
    <title>ToPack</title>
    <link rel="icon" href="../assets/ToPack_icon_no_shadow.png" type="image/x-icon">
</head>
<div id="navbar">

    
    <script type="text/javascript">
        $(function () {
            $("#navbar").load("navbar.html");
        });
    </script>

</div>

<body>
    <div class="container-fluid my-5 ">

        <div id="cards">
            <!-- Dinamically insert cards with shippings of the useer-->
        </div>
    </div>
</body>

<script>


    //var contractAddress = '0xd7cBE490a3236A67fb86752540619f05672d2699';
    var contractAddress = "0x2299e9bA7FDD6016eC8E39dd8F00C0917E221394";
    //console.log(contractAddress)
    var contractJSON = "../build/contracts/Pack.json";
    console.log(contractJSON)
    var senderAddress = '0x0';
    var contract;

    $(window).on('load', function () {
        run();
    });

    async function run() {
        if (typeof window.ethereum !== 'undefined') {
            console.log('MetaMask is installed!');
        }

        await window.ethereum.enable();

        const accounts = await ethereum.request({
            method: 'eth_requestAccounts',
        });
        console.log("Get account:", accounts)
        initialise(contractAddress, accounts)
    }

    async function initialise(contractAddress, accounts) {
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            web3 = new Web3(new Web3.providers.WebsocketProvider("ws://localhost:7545"));
        }

        await $.getJSON(contractJSON,
            function (contractData) {
                contract = new web3.eth.Contract(contractData.abi, contractAddress);
            }
        ).catch((error) => { console.error(error); });

        if (!contract) {
            console.error("No contract loaded.");
            return false;
        }
        senderAddress = accounts[0]
        console.log("Sender address set: " + senderAddress)
        var callback;
        contract.events.allEvents(
            callback = function (error, event) {
                if (error) {
                    console.error(error)
                }
                console.log(event);
            });

        subscribeToEvents()
        getUserPosts()
    }

    function subscribeToEvents() {
        var result;
        contract.events.PostsEvent( // Subscribe to all Win events
            function (error, event) {
                if (!error) {
                    result = event.PostsEvent();
                }
            }

        );
        return result;
    }

    async function getUserPosts() {

        var res = contract.methods.getUserPosts(senderAddress.toString()).call((err, result) => {
            var shippingCard = ''

            for (let i = 0; i < Object.values(result).length; i++) {
                shippingCard += '<div class="card border-ligth mx-auto mb-3" style="max-width: 85%;">\
                                        <div class="card-body">\
                                        <h2  class="card-title" align><b>Shipping id: '+ result[i][0] + '</b><h2>\
                                            <p class="card-text">\
                                                <img src="../assets/icons/sender_icon.svg" width="5%"height="5%"> '+ result[i][2] + '<br>\
                                            <img src="../assets/icons/package_icon.svg" width="5%"height="5%">'+ result[i][3] + '<br>\
                                            <img src="../assets/icons/shipping_icon.svg" width="5%"height="5%">'+ result[i][4] + '\
                                        </p></div>\
                                     </div>';
            }
            $('#cards').append(shippingCard);

        })
    }

</script>

</html>